
Description: >
  Spot Fleet for ECS

Parameters:
  VPC:
    Description: The VPC to deploy SpotFleet into
    Type: AWS::EC2::VPC::Id

  Subnets:
    Description: The subnets of a VPC to deploy SpotFleet into
    Type: List<AWS::EC2::Subnet::Id>

  ECSCluster:
    Description: The ECS Cluster to register with
    Type: String

  AMI:
    Description: The AMI to launch instances with
    Type: String

  InitialCapacity:
    Description: The initial capacity for the spot fleet
    Type: Number

  MaxPricePerUnitHour:
    Description: The maximum to bid per unit-hour
    Type: String

  KeyName:
    Type: String
    Default: ""

  CloudInitScript:
    Description: A URL to a cloud init script to be included in the instance user-data
    Type: String


Conditions:
  HasKeyName: !Not [ !Equals [ !Ref KeyName, "" ] ]

Resources:
  ECSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: "Security group for ECS instances"
      GroupDescription: "Security group for ECS instances"
      VpcId: !Ref VPC

  ECSSecurityGroupIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ECSSecurityGroup
      SourceSecurityGroupId: !Ref ECSSecurityGroup
      IpProtocol: tcp
      FromPort: 0
      ToPort: 65535

  SpotFleetIAMRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument: |
        {
          "Statement": [{
            "Action": "sts:AssumeRole",
            "Effect": "Allow",
            "Principal": {
              "Service": "spotfleet.amazonaws.com"
            }
          }]
        }
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2SpotFleetRole

  ECSRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      RoleName: !Sub ${AWS::StackName}-ECSRole-${AWS::Region}
      AssumeRolePolicyDocument: |
        {
          "Statement": [{
            "Action": "sts:AssumeRole",
            "Effect": "Allow",
            "Principal": {
              "Service": "ec2.amazonaws.com"
            }
          }]
        }
      Policies:
        - PolicyName: ecs-service
          PolicyDocument: |
            {
              "Statement": [{
                "Effect": "Allow",
                "Action": [
                "ecs:CreateCluster",
                "ecs:DeregisterContainerInstance",
                "ecs:DiscoverPollEndpoint",
                "ecs:Poll",
                "ecs:RegisterContainerInstance",
                "ecs:StartTelemetrySession",
                "ecs:Submit*",
                "logs:CreateLogStream",
                "logs:PutLogEvents",
                "ecr:BatchCheckLayerAvailability",
                "ecr:BatchGetImage",
                "ecr:GetDownloadUrlForLayer",
                "ecr:GetAuthorizationToken"
                ],
                "Resource": "*"
              }]
            }

  ECSInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref ECSRole

  SpotFleet:
    Type: AWS::EC2::SpotFleet
    Properties:
      SpotFleetRequestConfigData:
        AllocationStrategy: lowestPrice
        IamFleetRole: !GetAtt SpotFleetIAMRole.Arn
        TargetCapacity: !Ref InitialCapacity
        SpotPrice: !Ref MaxPricePerUnitHour
        LaunchSpecifications:
          - WeightedCapacity: 4
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: m5.large
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 8
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: m5.xlarge
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 16
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: m5.2xlarge
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 32
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: m5.4xlarge
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 4
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: c5.large
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 8
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: c5.xlarge
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 16
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: c5.2xlarge
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 32
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: c5.4xlarge
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 1
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: t2.small
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 2
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: t2.medium
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 4
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: t2.large
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 8
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: t2.xlarge
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 4
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: m4.large
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 8
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: m4.xlarge
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 16
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: m4.2xlarge
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 32
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: m4.4xlarge
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 4
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: c4.large
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 8
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: c4.xlarge
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 16
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: c4.2xlarge
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--

          - WeightedCapacity: 32
            IamInstanceProfile: { Arn: !GetAtt ECSInstanceProfile.Arn }
            InstanceType: c4.4xlarge
            ImageId: !Ref AMI
            KeyName: !If [HasKeyName, !Ref KeyName, !Ref "AWS::NoValue"]
            SecurityGroups:
              - GroupId: !GetAtt ECSSecurityGroup.GroupId
            SubnetId: !Join [", ", !Ref Subnets]
            UserData:
              "Fn::Base64": !Sub |
                Content-Type: multipart/mixed; boundary="==BOUNDARY=="
                MIME-Version: 1.0

                --==BOUNDARY==
                Content-Type: text/x-shellscript; charset="us-ascii"

                #!/bin/bash
                yum install -y aws-cfn-bootstrap
                echo ECS_CLUSTER=${ECSCluster} >> /etc/ecs/ecs.config
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource SpotFleet --region ${AWS::Region}

                --==BOUNDARY==--
                Content-Type: text/x-include-url; charset="us-ascii"
                #!/bin/bash

                [${CloudInitScript}]
                --==BOUNDARY==--


Outputs:
  SpotFleet:
    Description: The SpotFleet created
    Value: !Ref SpotFleet
